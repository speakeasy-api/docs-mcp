# Environment setup: copy mise.local.toml.example â†’ mise.local.toml and fill in API keys.
[tools]
hk = "1.36.0"
node = "24.13.1"
pkl = "0.30.2"

[tasks."index-fixtures"]
description = "Build test fixture index from tests/fixtures/docs"
run = "node packages/cli/dist/index.js build --docs-dir tests/fixtures/docs --out tests/fixtures/index --embedding-provider hash"
depends = ["build"]

[tasks."serve:http"]
description = "Start MCP docs server over Streamable HTTP (set PORT to override)"
run = "node packages/server/dist/bin.js --index-dir tests/fixtures/index --transport http --port ${PORT:-20310}"
sources = ["packages/server/src/**"]
depends = ["index-fixtures"]

[tasks."inspect:http"]
description = "Run MCP Inspector against local MCP HTTP server (set MCP_SERVER_URL or PORT to override)"
run = "MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:${PORT:-20310}/mcp} npx @modelcontextprotocol/inspector"

[tasks.build]
description = "Build all packages"
run = "pnpm build"

[tasks.test]
description = "Run all tests"
run = "pnpm test"
depends = ["index-fixtures"]

[tasks."test:server"]
description = "Run server package tests (including HTTP transport)"
run = "pnpm --filter @speakeasy-api/docs-mcp-server test"
depends = ["index-fixtures"]

[tasks.playground]
description = "Start playground (MCP server + Vite dev server)"
run = 'mprocs "node packages/server/dist/bin.js --index-dir tests/fixtures/index --transport http --port ${PORT:-20310}" "cd packages/playground && npx vite"'
depends = ["index-fixtures"]

[tasks."playground:no-gram"]
description = "Start playground without GRAM_API_KEY (chat disabled)"
run = 'GRAM_API_KEY= mprocs "node packages/server/dist/bin.js --index-dir tests/fixtures/index --transport http --port ${PORT:-20310}" "cd packages/playground && npx vite"'
depends = ["index-fixtures"]

[tasks."playground:server"]
description = "Start only the playground API server"
run = "node packages/playground/src/server.ts"
depends = ["build"]

[tasks."playground:client"]
description = "Start only the playground Vite dev server"
run = "cd packages/playground && npx vite"

[tasks."bench:realistic"]
description = "Benchmark embedding providers against realistic test fixture (none, hash)"
run = "node packages/eval/dist/bin.js benchmark --cases packages/eval/fixtures/realistic/cases.json --docs-dir packages/eval/fixtures/realistic --work-dir /tmp/bench-realistic --build-command packages/cli/dist/index.js --server-command packages/server/dist/bin.js --embeddings none,hash"
depends = ["build"]

[tasks."agent-eval"]
description = "Run agent eval suite (e.g. `mise agent-eval acmeauth -- --include ts-init`)"
usage = '''
arg "<suite>" help="Named scenario suite (e.g. acmeauth, dub-go)"
arg "[args]" var=#true help="Extra args passed to the eval CLI"
'''
run = 'node packages/eval/dist/bin.js agent-eval --suite "$usage_suite" $usage_args'
depends = ["build"]

[tasks."agent-eval:debug"]
description = "Run agent eval with --debug (keeps workspaces)"
usage = '''
arg "<suite>" help="Named scenario suite"
arg "[args]" var=#true help="Extra args passed to the eval CLI"
'''
run = 'node packages/eval/dist/bin.js agent-eval --suite "$usage_suite" --debug $usage_args'
depends = ["build"]

[tasks."agent-eval:prompt"]
description = "Run ad-hoc agent eval with a prompt"
usage = '''
arg "<prompt>" help="The prompt to send to the agent"
flag "--docs-dir <path>" help="Path to docs directory" required=#true
arg "[args]" var=#true help="Extra args passed to the eval CLI"
'''
run = 'node packages/eval/dist/bin.js agent-eval --prompt "$usage_prompt" --docs-dir "$usage_docs_dir" $usage_args'
depends = ["build"]

[tasks."agent-eval:openai"]
description = "Run agent eval suite with OpenAI Codex provider"
usage = '''
arg "<suite>" help="Named scenario suite (e.g. acmeauth, dub-go)"
arg "[args]" var=#true help="Extra args passed to the eval CLI"
'''
run = 'node packages/eval/dist/bin.js agent-eval --suite "$usage_suite" --provider openai $usage_args'
depends = ["build"]

[tasks."agent-eval:suites"]
description = "List available agent eval suites"
run = "ls -1 packages/eval/fixtures/agent-scenarios/*.json | xargs -I{} basename {} .json"

[tasks.nuke]
description = "Kill all processes attached to dev ports (20310, 3000)"
run = '''
set +e
for port in 20310 3000; do
  pids=$(lsof -ti :$port)
  if [ -n "$pids" ]; then
    echo "Killing processes on port $port: $pids"
    echo "$pids" | xargs kill -9
  else
    echo "No processes on port $port"
  fi
done
'''
